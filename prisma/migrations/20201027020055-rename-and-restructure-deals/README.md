# Migration `20201027020055-rename-and-restructure-deals`

This migration has been generated by Rinat at 10/27/2020, 5:00:55 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."deals.buyerBidId_sellerBidId_unique"

DROP INDEX "public"."deals_buyerBidId_unique"

DROP INDEX "public"."deals_sellerBidId_unique"

ALTER TABLE "public"."deals" DROP CONSTRAINT "deals_buyerBidId_fkey"

ALTER TABLE "public"."deals" DROP CONSTRAINT "deals_sellerBidId_fkey"

ALTER TABLE "public"."deals" DROP COLUMN "buyerBidId",
DROP COLUMN "sellerBidId",
ADD COLUMN "demandBidId" text   NOT NULL ,
ADD COLUMN "offerBidId" text   NOT NULL 

CREATE UNIQUE INDEX "deals.demandBidId_offerBidId_unique" ON "public"."deals"("demandBidId", "offerBidId")

CREATE UNIQUE INDEX "deals_demandBidId_unique" ON "public"."deals"("demandBidId")

ALTER TABLE "public"."deals" ADD FOREIGN KEY ("demandBidId")REFERENCES "public"."bids"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."deals" ADD FOREIGN KEY ("offerBidId")REFERENCES "public"."bids"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201026232553-add-coal-fraction-to-bid-model..20201027020055-rename-and-restructure-deals
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 enum Role {
   BUYER
@@ -97,10 +97,10 @@
   type BidType
   resourse Resourse
   coalMark CoalMark
   coalFraction CoalFraction
-  buyerDeal DealModel  @relation("buyer_bid_deals")
-  sellerDeal DealModel @relation("seller_bid_deals")
+  demandDeal DealModel  @relation("demand_bid_deals")
+  offerDeals DealModel[] @relation("offer_bid_deals")
   creator UserModel @relation(fields: [creatorId], references: [id])
   location LocationModel @relation(fields: [locationId], references: [id])
   createdAt DateTime @default(now())
@@ -111,19 +111,19 @@
 model DealModel {
   id       String  @id @default(cuid())
-  buyerBidId String
-  sellerBidId String
+  demandBidId String
+  offerBidId String
   matcherId String
-  buyerBid BidModel @relation("buyer_bid_deals", fields: [buyerBidId], references: [id])
-  sellerBid BidModel @relation("seller_bid_deals", fields: [sellerBidId], references: [id])
+  demandBid BidModel @relation("demand_bid_deals", fields: [demandBidId], references: [id])
+  offerBid BidModel @relation("offer_bid_deals", fields: [offerBidId], references: [id])
   matcher UserModel @relation(fields: [matcherId], references: [id])
   createdAt DateTime @default(now())
-  @@unique([buyerBidId, sellerBidId])
+  @@unique([demandBidId, offerBidId])
   @@map("deals")
 }
 model LocationModel {
```


